/**
 * Chat Service - Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Chat API
 * 
 * Ğ­Ñ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ backend API
 */

// ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ API
const API_CONFIG = {
  baseURL: 'https://your-backend-api.com', // Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²Ğ°Ñˆ URL
  endpoints: {
    sendMessage: '/api/chat/message',
    getHistory: '/api/chat/history',
    createSession: '/api/chat/session'
  },
  timeout: 10000 // 10 ÑĞµĞºÑƒĞ½Ğ´
};

/**
 * ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ñ‡Ğ°Ñ‚
 * 
 * @param {string} message - Ğ¢ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
 * @param {string} sessionId - ID ÑĞµÑÑĞ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ° (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
 * @returns {Promise<Object>} ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Ğ±Ğ¾Ñ‚Ğ°
 * 
 * ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
 * const response = await sendChatMessage("ĞŸÑ€Ğ¸Ğ²ĞµÑ‚!", "session-123");
 */
export const sendChatMessage = async (message, sessionId = null) => {
  try {
    // 1. ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
    const requestBody = {
      message: message,
      sessionId: sessionId,
      timestamp: new Date().toISOString(),
      // Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸:
      userId: localStorage.getItem('userId') || null,
      language: 'ru'
    };

    console.log('ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°:', requestBody);

    // 2. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° POST Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº API
    const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.sendMessage}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // Ğ•ÑĞ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:
        // 'Authorization': `Bearer ${getAuthToken()}`
      },
      body: JSON.stringify(requestBody),
      // Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
      signal: AbortSignal.timeout(API_CONFIG.timeout)
    });

    // 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
    }

    // 4. ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ JSON Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    const data = await response.json();
    
    console.log('ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ¾Ñ‚Ğ²ĞµÑ‚:', data);

    // 5. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    return {
      success: true,
      message: data.response || data.message,
      sessionId: data.sessionId,
      timestamp: data.timestamp || new Date().toISOString(),
      metadata: data.metadata || {}
    };

  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:', error);

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
    if (error.name === 'AbortError') {
      return {
        success: false,
        error: 'Timeout',
        message: 'ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ°'
      };
    }

    if (error.message.includes('Failed to fetch')) {
      return {
        success: false,
        error: 'NetworkError',
        message: 'ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ'
      };
    }

    return {
      success: false,
      error: error.name,
      message: 'ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ'
    };
  }
};

/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ°
 * 
 * @param {string} sessionId - ID ÑĞµÑÑĞ¸Ğ¸
 * @returns {Promise<Array>} ĞœĞ°ÑÑĞ¸Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
 */
export const getChatHistory = async (sessionId) => {
  try {
    const response = await fetch(
      `${API_CONFIG.baseURL}${API_CONFIG.endpoints.getHistory}?sessionId=${sessionId}`,
      {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      }
    );

    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status}`);
    }

    const data = await response.json();
    return data.messages || [];

  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸:', error);
    return [];
  }
};

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ°
 * 
 * @returns {Promise<string>} ID Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸
 */
export const createChatSession = async () => {
  try {
    const response = await fetch(
      `${API_CONFIG.baseURL}${API_CONFIG.endpoints.createSession}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          timestamp: new Date().toISOString()
        })
      }
    );

    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status}`);
    }

    const data = await response.json();
    return data.sessionId;

  } catch (error) {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ ÑĞµÑÑĞ¸Ğ¸:', error);
    // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ID ĞµÑĞ»Ğ¸ API Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
    return `local-${Date.now()}`;
  }
};

/**
 * MOCK Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±ĞµĞ· backend
 * Ğ˜Ğ¼Ğ¸Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºÑƒ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
 */
export const sendChatMessageMock = async (message, lang = 'en') => {
  // Ğ˜Ğ¼Ğ¸Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¸ ÑĞµÑ‚Ğ¸ (500-1500ms)
  const delay = Math.random() * 1000 + 500;
  await new Promise(resolve => setTimeout(resolve, delay));

  const responsesByLang = {
    en: [
      'Thanks for your message! How can I help?',
      'Great question. Let me think through the best answer.',
      'I can help with redesign, features, and project scope.',
      `You wrote: "${message}". Do you want an estimate or implementation plan?`,
    ],
    he: [
      '×ª×•×“×” ×¢×œ ×”×”×•×“×¢×”! ××™×š ××¤×©×¨ ×œ×¢×–×•×¨?',
      '×©××œ×” ××¦×•×™× ×ª. ×‘×•× × ×—×©×•×‘ ×¢×œ ×”×¤×ª×¨×•×Ÿ ×”×˜×•×‘ ×‘×™×•×ª×¨.',
      '×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×¢× ×©×“×¨×•×’ ××ª×¨, ×¤×™×¦\'×¨×™× ×•×ª×›× ×•×Ÿ ×”×¤×¨×•×™×§×˜.',
      `×›×ª×‘×ª: "${message}". ×ª×¨×¦×” ×”×¢×¨×›×ª ×¢×œ×•×ª ××• ×ª×•×›× ×™×ª ×™×™×©×•×?`,
    ],
    ru: [
      'Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ! Ğ§ĞµĞ¼ Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ?',
      'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ. Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ±ĞµÑ€ĞµĞ¼ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ.',
      'Ğ¯ Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ñ€ĞµĞ´Ğ¸Ğ·Ğ°Ğ¹Ğ½Ğ¾Ğ¼, Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ğ¾Ñ†ĞµĞ½ĞºĞ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°.',
      `Ğ’Ñ‹ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸: "${message}". Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ†ĞµĞ½ĞºÑƒ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¿Ğ»Ğ°Ğ½ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸?`,
    ],
  };

  const mockResponses = responsesByLang[lang] || responsesByLang.en;

  const randomResponse = mockResponses[Math.floor(Math.random() * mockResponses.length)];

  return {
    success: true,
    message: randomResponse,
    sessionId: 'mock-session-123',
    timestamp: new Date().toISOString()
  };
};

// Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
export { API_CONFIG };
